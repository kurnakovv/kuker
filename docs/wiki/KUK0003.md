## üí° Title
KUK0003MinMaxOnEmptySequenceAnalyzer

## üÜî Rule ID
KUK0003

## üìù Description
`Min`/`Max` (including async equivalents) and `MinBy`/`MaxBy` can throw [System.InvalidOperationException](https://learn.microsoft.com/en-us/dotnet/api/system.invalidoperationexception?view=net-8.0) when applied to empty sequences of non-nullable value types.

[Min](https://learn.microsoft.com/en-us/dotnet/api/system.linq.enumerable.min?view=net-8.0)/[Max](https://learn.microsoft.com/en-us/dotnet/api/system.linq.enumerable.max?view=net-8.0)/[MinAsync](https://learn.microsoft.com/en-us/dotnet/api/system.data.entity.queryableextensions.minasync?view=entity-framework-6.2.0)/[MaxAsync](https://learn.microsoft.com/en-us/dotnet/api/system.data.entity.queryableextensions.maxasync?view=entity-framework-6.2.0) can be made safe by using a nullable selector or [.DefaultIfEmpty()](https://learn.microsoft.com/en-us/dotnet/api/system.linq.enumerable.defaultifempty?view=net-8.0)

[MinBy](https://learn.microsoft.com/en-us/dotnet/api/system.linq.enumerable.minby?view=net-8.0)/[MaxBy](https://learn.microsoft.com/en-us/dotnet/api/system.linq.enumerable.maxby?view=net-8.0) always require [.DefaultIfEmpty()](https://learn.microsoft.com/en-us/dotnet/api/system.linq.enumerable.defaultifempty?view=net-8.0), as a nullable selector does not prevent the exception.

This rule detects cases where you forgot to add a nullable selector or call the [.DefaultIfEmpty()](https://learn.microsoft.com/en-us/dotnet/api/system.linq.enumerable.defaultifempty?view=net-8.0) method

## ‚ùî Why this is a problem
Imagine you're working with a collection of value types and need to get the maximum value. You use the [.Max()](https://learn.microsoft.com/en-us/dotnet/api/system.linq.enumerable.max?view=net-8.0#system-linq-enumerable-max(system-collections-generic-ienumerable((system-decimal)))) method, everything builds fine, but at runtime, an exception occurs: `System.InvalidOperationException: 'Sequence contains no elements'`

This isn't the most obvious behavior at first glance, which is why this rule exists.

## ‚öôÔ∏è Configuration

You can configure the severity of the rule using .editorconfig.
```.editorconfig
[*.cs]
dotnet_diagnostic.KUK0003.severity = warning # Min/Max (Async) and MinBy/MaxBy may throw InvalidOperationException on empty sequences | https://github.com/kurnakovv/kuker/wiki/KUK0003
```

## üíª Examples
`.Max()` with a collection of primitive types
```cs
List<int> numbers = [];

int maxNumberViolation = numbers.Max(); // ‚ùå Violation, because no null selector or .DefaultIfEmpty()

int maxNumberOK1 = numbers.DefaultIfEmpty().Max(); // ‚úÖ OK
int maxNumberOK2 = numbers.Max(x => (int?)x) ?? 0; // ‚úÖ OK
```

All `Min`/`Max` methods
```cs
public class UserDto
{
    public required string Name { get; set; }
    public required int Age { get; set; }
}

List<UserDto> items = [];

int minAgeViolation = items.Min(x => x.Age); // ‚ùå Violation
int maxAgeViolation = items.Max(x => x.Age); // ‚ùå Violation
UserDto? minUserByAgeViolation = items.MinBy(x => x.Age); // ‚ùå Violation
UserDto? maxUserByAgeViolation = items.MaxBy(x => x.Age); // ‚ùå Violation
int minAsyncAgeViolation = await items.AsQueryable().MinAsync(x => x.Age); // ‚ùå Violation
int maxAsyncAgeViolation = await items.AsQueryable().MaxAsync(x => x.Age); // ‚ùå Violation

int minAgeOK = items.Min(x => (int?)x.Age) ?? 0; // ‚úÖ OK | Or .DefaultIfEmpty()
int maxAgeOK = items.Max(x => (int?)x.Age) ?? 0; // ‚úÖ OK | Or .DefaultIfEmpty()
UserDto? minUserByAgeOK = items.DefaultIfEmpty(new UserDto()).MinBy(x => x.Age); // ‚úÖ OK | Only .DefaultIfEmpty()
UserDto? maxUserByAgeOK = items.DefaultIfEmpty(new UserDto()).MaxBy(x => x.Age); // ‚úÖ OK | Only .DefaultIfEmpty()
int minAsyncAgeOK = await items.AsQueryable().MinAsync(x => (int?)x.Age) ?? 0; // ‚úÖ OK | Or .DefaultIfEmpty()
int maxAsyncAgeOK = await items.AsQueryable().MaxAsync(x => (int?)x.Age) ?? 0; // ‚úÖ OK | Or .DefaultIfEmpty()
```

> [!NOTE]
> Use EntityFramework Core [DbContext](https://learn.microsoft.com/en-us/dotnet/api/system.data.entity.dbcontext?view=entity-framework-6.2.0) instead of `items.AsQueryable()`, because this case will not work at runtime

## üóíÔ∏è Notes
* [LINQ](https://learn.microsoft.com/en-us/dotnet/csharp/linq/) | It works only for Linq methods.

* [.GroupBy()](https://learn.microsoft.com/en-us/dotnet/api/system.linq.enumerable.groupby?view=net-8.0) method | This rule ignores sequences that use .GroupBy(), as Min/Max do not throw InvalidOperationException in this scenario, making diagnostics for this case unnecessary.

* [Value](https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/builtin-types/value-types)/[Reference](https://learn.microsoft.com/en-us/dotnet/csharp/language-reference/keywords/reference-types) types | This rule only works for value types, not reference types, since reference types don't throw a [System.InvalidOperationException](https://learn.microsoft.com/en-us/dotnet/api/system.invalidoperationexception?view=net-8.0) exception on empty sequences.

* [.Select()](https://learn.microsoft.com/en-us/dotnet/api/system.linq.enumerable.select?view=net-8.0) method | If you use a nullable selector via the `.Select()` method, the rule will also work.

## üîó Links
- Issues: [#27](https://github.com/kurnakovv/kuker/issues/27)
- [Source code](https://github.com/kurnakovv/kuker/blob/dev/src/Kuker.Analyzers/Rules/Kuk0003MinMaxOnEmptySequenceAnalyzer.cs)  
- More examples in [tests](https://github.com/kurnakovv/kuker/blob/dev/tests/Kuker.Analyzers.Tests/Rules/Kuk0003MinMaxOnEmptySequenceAnalyzer.cs)  
- [Severity levels](https://learn.microsoft.com/en-us/dotnet/fundamentals/code-analysis/configuration-options#severity-level)
